# 构建配置

<cite>
**本文档中引用的文件**  
- [docker-compose.yml](file://docker-compose.yml)
- [backend/Dockerfile](file://backend/Dockerfile)
- [backend/pyproject.toml](file://backend/pyproject.toml)
- [dev-setup.sh](file://dev-setup.sh)
- [Makefile](file://Makefile)
</cite>

## 目录
1. [Docker Compose 构建配置](#docker-compose-构建配置)  
2. [Dockerfile 详细解析](#dockerfile-详细解析)  
3. [依赖管理与构建流程](#依赖管理与构建流程)  
4. [指令作用与执行优先级](#指令作用与执行优先级)  
5. [构建优化建议](#构建优化建议)

## Docker Compose 构建配置

在 `docker-compose.yml` 文件中，后端服务（backend）的构建配置通过 `build` 指令定义，包含 `context` 和 `dockerfile` 两个关键参数：

- **context**: 指定为 `./backend`，表示 Docker 构建上下文为项目根目录下的 `backend` 子目录。Docker 在构建镜像时会将该目录下的所有文件作为上下文发送到构建环境中。
- **dockerfile**: 明确指定使用 `backend` 目录中的 `Dockerfile` 作为构建指令文件。

此配置确保了镜像构建过程仅关注后端代码，避免前端或其他无关文件被纳入构建上下文，提升构建效率与安全性。

此外，`command` 指令在 `docker-compose.yml` 中覆盖了容器启动时的默认命令，执行数据库迁移、静态文件收集和 Gunicorn 服务启动三步操作，确保服务启动前完成必要的初始化步骤。

**Section sources**  
- [docker-compose.yml](file://docker-compose.yml#L21-L44)

## Dockerfile 详细解析

`backend/Dockerfile` 定义了后端服务的完整镜像构建流程，其核心指令如下：

- **FROM**: 使用 `docker.m.daocloud.io/python:3.11-slim` 作为基础镜像，该镜像是官方 Python 镜像的轻量版本，适用于生产环境，减少攻击面并加快构建速度。
- **WORKDIR**: 设置工作目录为 `/app`，后续所有命令均在此目录下执行，确保路径一致性。
- **COPY**: 分步复制项目文件，优先复制 `pyproject.toml`、`manage.py` 及核心代码目录（`todo_project` 和 `apps`），以利用 Docker 层缓存机制。
- **EXPOSE**: 声明容器在运行时监听 8000 端口，提示用户该服务对外暴露的端口，但不实际进行端口映射（需在 `docker-compose.yml` 中配置）。

该 Dockerfile 结构清晰，遵循最佳实践，确保构建过程可重复且高效。

**Section sources**  
- [backend/Dockerfile](file://backend/Dockerfile#L1-L26)

## 依赖管理与构建流程

项目采用现代 Python 依赖管理工具 `uv` 进行包安装，其优势在于极快的解析速度和确定性构建。

- **uv 安装**: 通过 `RUN pip install uv` 在容器内安装 `uv` 工具。
- **依赖安装命令**: `RUN uv pip install --system -r pyproject.toml` 使用 `--system` 模式将包安装到系统环境，避免虚拟环境开销，适合容器化部署。
- **pyproject.toml**: 该文件定义了项目依赖，包括 Django、DRF、Gunicorn 等核心库，确保依赖声明与构建过程解耦。

构建过程中，静态文件通过 `python manage.py collectstatic --noinput || true` 收集至指定目录，确保前端可访问 Django 管理的静态资源。

**Section sources**  
- [backend/Dockerfile](file://backend/Dockerfile#L6-L19)
- [backend/pyproject.toml](file://backend/pyproject.toml#L1-L33)

## 指令作用与执行优先级

Docker 构建和运行过程中涉及多个指令，其作用与优先级如下：

- **WORKDIR**: 设置工作目录，影响后续所有指令的执行路径。
- **EXPOSE**: 仅声明端口，不执行实际映射，实际端口绑定由 `docker-compose.yml` 中的 `ports` 配置完成。
- **CMD**: 在 `Dockerfile` 中定义容器默认启动命令，本项目中为 Gunicorn 启动命令。
- **command（docker-compose.yml）**: 覆盖 `Dockerfile` 中的 `CMD` 指令，优先级更高。本项目中，`command` 执行多步操作（迁移、收集静态文件、启动服务），确保服务启动前完成初始化。

因此，`docker-compose.yml` 中的 `command` 指令优先级高于 `Dockerfile` 中的 `CMD`，允许在编排层面灵活控制容器行为。

**Section sources**  
- [docker-compose.yml](file://docker-compose.yml#L41-L44)
- [backend/Dockerfile](file://backend/Dockerfile#L24-L25)

## 构建优化建议

为提升构建效率、安全性和可维护性，提出以下优化建议：

### 多阶段构建
当前 `Dockerfile` 为单阶段构建，建议引入多阶段构建：
- **构建阶段**: 使用包含编译工具的完整 Python 镜像安装依赖（如含 C 扩展的包）。
- **运行阶段**: 基于 `python:3.11-slim` 镜像，仅复制已安装的依赖和应用代码，显著减小镜像体积。

### 缓存利用优化
- 将 `pyproject.toml` 单独复制并提前安装依赖，利用 Docker 层缓存。当仅代码变更时，无需重新安装依赖。
- 示例优化顺序：
  ```dockerfile
  COPY pyproject.toml .
  RUN uv pip install --system -r pyproject.toml
  COPY . .
  ```

### 安全加固措施
- **非 root 用户运行**: 创建专用用户运行应用，避免容器以 root 权限运行。
- **镜像来源可信**: 使用官方或可信镜像源（如 `docker.m.daocloud.io` 作为镜像加速器）。
- **依赖审计**: 定期检查 `pyproject.toml` 和 `uv.lock` 中的依赖是否存在已知漏洞。
- **最小化安装**: 仅安装必要依赖，避免引入不必要的系统包。

### 其他建议
- **使用 .dockerignore**: 添加 `.dockerignore` 文件，排除 `__pycache__`、`.git`、`tests/` 等非必要文件，减少上下文传输。
- **健康检查**: 在 `docker-compose.yml` 中为后端服务添加 `healthcheck`，确保服务真正就绪后再接受流量。

**Section sources**  
- [docker-compose.yml](file://docker-compose.yml#L1-L61)
- [backend/Dockerfile](file://backend/Dockerfile#L1-L26)
- [dev-setup.sh](file://dev-setup.sh#L1-L58)
- [Makefile](file://Makefile#L1-L56)