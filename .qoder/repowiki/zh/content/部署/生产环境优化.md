# 生产环境优化

<cite>
**本文档引用的文件**   
- [nginx.conf](file://frontend/nginx.conf)
- [Dockerfile](file://frontend/Dockerfile)
- [docker-compose.yml](file://docker-compose.yml)
</cite>

## 目录
1. [简介](#简介)
2. [Nginx反向代理配置](#nginx反向代理配置)
3. [单页应用路由支持](#单页应用路由支持)
4. [静态资源缓存策略](#静态资源缓存策略)
5. [Gzip压缩配置](#gzip压缩配置)
6. [性能调优建议](#性能调优建议)
7. [HTTPS配置指引](#https配置指引)

## 简介
本指南基于项目中的`nginx.conf`配置文件，详细说明在生产环境中如何优化Nginx服务器配置。该配置用于前端服务，通过Docker部署，将API请求代理到后端服务，并为单页应用提供路由支持和静态资源缓存。本文档涵盖反向代理、缓存策略、压缩配置及性能调优等关键优化点。

## Nginx反向代理配置

Nginx作为反向代理服务器，负责将`/api`路径的请求转发至后端Django应用（运行在8000端口）。在`docker-compose.yml`中，后端服务名为`backend`，因此`proxy_pass`指令使用`http://backend:8000`进行内部服务发现。

为确保后端应用能正确获取客户端信息，配置中设置了多个关键请求头：
- `Host $host`：传递原始请求的主机头，确保后端生成的链接正确。
- `X-Real-IP $remote_addr`：传递客户端的真实IP地址。
- `X-Forwarded-For $proxy_add_x_forwarded_for`：将客户端IP追加到请求头链中，便于日志记录和安全审计。
- `X-Forwarded-Proto $scheme`：传递原始请求的协议（HTTP/HTTPS），确保后端能正确生成安全链接。

此配置确保了前后端分离架构下的请求透明性和安全性。

**Section sources**
- [nginx.conf](file://frontend/nginx.conf#L18-L24)

## 单页应用路由支持

对于基于React的单页应用（SPA），前端路由由客户端JavaScript处理，而非服务器。当用户直接访问如`/tasks`或`/projects`等路由时，服务器上并不存在对应的物理文件，若不加处理将返回404错误。

通过`try_files $uri $uri/ /index.html`指令，Nginx会按顺序尝试：
1. 查找请求的URI对应的文件（如`/index.html`）。
2. 查找请求的URI对应的目录（如`/assets/`）。
3. 若前两者均未找到，则返回`/index.html`文件。

此机制将所有未知路径的请求交由前端路由处理，实现了SPA的无缝导航。

**Section sources**
- [nginx.conf](file://frontend/nginx.conf#L15)

## 静态资源缓存策略

为提升页面加载性能，对静态资源实施了长效缓存策略。配置通过正则表达式匹配常见的静态文件扩展名，包括JS、CSS、图片和字体文件。

关键缓存指令：
- `expires 1y`：设置HTTP响应头`Expires`和`Cache-Control: max-age`为1年，指示浏览器和中间代理长期缓存这些资源。
- `add_header Cache-Control "public, immutable"`：添加额外的`Cache-Control`指令，`public`表示资源可被任何缓存存储，`immutable`表示资源内容永不改变，浏览器可安全地跳过后续的重新验证请求。

此策略极大减少了重复访问时的网络请求，显著提升用户体验。

**Section sources**
- [nginx.conf](file://frontend/nginx.conf#L27-L30)

## Gzip压缩配置

Gzip压缩可有效减小传输数据体积，降低带宽消耗并加快页面加载速度。

配置说明：
- `gzip on`：启用Gzip压缩功能。
- `gzip_vary on`：添加`Vary: Accept-Encoding`响应头，帮助代理缓存服务器区分压缩与非压缩版本。
- `gzip_min_length 1024`：仅对大于1KB的文件进行压缩，避免对小文件压缩造成不必要的CPU开销。
- `gzip_types`：指定需要压缩的MIME类型，涵盖文本、CSS、JavaScript和JSON等可压缩的文本类资源。

此配置在性能和资源消耗之间取得了良好平衡。

**Section sources**
- [nginx.conf](file://frontend/nginx.conf#L9-L12)

## 性能调优建议

### Worker进程配置
虽然当前配置未显式设置`worker_processes`和`worker_connections`，但在生产环境中，建议根据服务器CPU核心数进行优化。通常设置`worker_processes auto;`以自动匹配CPU核心数，并根据预期并发量调整`worker_connections`。

### 连接超时设置
为优化资源利用，建议添加以下超时配置：
- `keepalive_timeout`：启用HTTP长连接，减少TCP握手开销。
- `client_header_timeout` 和 `client_body_timeout`：设置客户端请求头和请求体的读取超时，防止慢速攻击。
- `send_timeout`：设置响应发送超时。

### SSL/TLS配置指引
当前配置仅监听HTTP（端口80）。在生产环境中，必须配置HTTPS以确保数据传输安全。建议：
1. 使用`listen 443 ssl http2;`启用HTTPS和HTTP/2。
2. 通过`ssl_certificate`和`ssl_certificate_key`指令指定SSL证书和私钥路径。
3. 配置强加密套件，例如使用Mozilla推荐的现代兼容性配置。
4. 启用HSTS（`add_header Strict-Transport-Security`）强制浏览器使用HTTPS。

**Section sources**
- [nginx.conf](file://frontend/nginx.conf#L2)
- [docker-compose.yml](file://docker-compose.yml#L52)

## HTTPS配置指引

为实现安全的HTTPS部署，需对`nginx.conf`进行扩展。建议在Docker环境中通过挂载卷的方式提供SSL证书。

配置示例：
```nginx
server {
    listen 443 ssl http2;
    server_name your-domain.com;

    ssl_certificate /etc/nginx/ssl/fullchain.pem;
    ssl_certificate_key /etc/nginx/ssl/privkey.pem;

    # Mozilla推荐的现代配置
    ssl_protocols TLSv1.3;
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256;
    ssl_prefer_server_ciphers off;

    # HSTS
    add_header Strict-Transport-Security "max-age=31536000" always;

    # ... 其余配置保持不变
}
```

同时，可通过301重定向将HTTP流量强制跳转至HTTPS，确保所有通信安全。

**Section sources**
- [nginx.conf](file://frontend/nginx.conf)
- [Dockerfile](file://frontend/Dockerfile)