# 后端架构

<cite>
**本文档中引用的文件**
- [settings.py](file://backend/todo_project/settings.py)
- [urls.py](file://backend/todo_project/urls.py)
- [users/models.py](file://backend/apps/users/models.py)
- [tasks/models.py](file://backend/apps/tasks/models.py)
- [projects/models.py](file://backend/apps/projects/models.py)
- [tags/models.py](file://backend/apps/tags/models.py)
- [users/views.py](file://backend/apps/users/views.py)
- [tasks/views.py](file://backend/apps/tasks/views.py)
- [projects/views.py](file://backend/apps/projects/views.py)
- [tags/views.py](file://backend/apps/tags/views.py)
- [users/serializers.py](file://backend/apps/users/serializers.py)
- [tasks/serializers.py](file://backend/apps/tasks/serializers.py)
- [projects/serializers.py](file://backend/apps/projects/serializers.py)
- [tags/serializers.py](file://backend/apps/tags/serializers.py)
- [users/urls.py](file://backend/apps/users/urls.py)
- [tasks/urls.py](file://backend/apps/tasks/urls.py)
- [projects/urls.py](file://backend/apps/projects/urls.py)
- [tags/urls.py](file://backend/apps/tags/urls.py)
</cite>

## 目录
1. [项目结构](#项目结构)
2. [核心模块关系](#核心模块关系)
3. [配置分析](#配置分析)
4. [API路由设计](#api路由设计)
5. [MVC架构实现](#mvc架构实现)
6. [组件交互流程](#组件交互流程)

## 项目结构

Django项目采用模块化设计，将功能划分为独立的应用。主项目`todo_project`负责全局配置和路由分发，而具体功能由`users`、`tasks`、`projects`、`tags`四个应用实现。

```mermaid
graph TD
subgraph "主项目"
todo_project["todo_project (主项目)"]
settings["settings.py (配置)"]
urls["urls.py (根路由)"]
end
subgraph "功能应用"
users["users (用户管理)"]
tasks["tasks (任务管理)"]
projects["projects (项目管理)"]
tags["tags (标签管理)"]
end
todo_project --> settings
todo_project --> urls
urls --> users
urls --> tasks
urls --> projects
urls --> tags
users --> models1["models.py"]
users --> views1["views.py"]
users --> serializers1["serializers.py"]
users --> urls1["urls.py"]
tasks --> models2["models.py"]
tasks --> views2["views.py"]
tasks --> serializers2["serializers.py"]
tasks --> urls2["urls.py"]
projects --> models3["models.py"]
projects --> views3["views.py"]
projects --> serializers3["serializers.py"]
projects --> urls3["urls.py"]
tags --> models4["models.py"]
tags --> views4["views.py"]
tags --> serializers4["serializers.py"]
tags --> urls4["urls.py"]
```

**图示来源**
- [settings.py](file://backend/todo_project/settings.py)
- [urls.py](file://backend/todo_project/urls.py)

**本节来源**
- [settings.py](file://backend/todo_project/settings.py)
- [urls.py](file://backend/todo_project/urls.py)

## 核心模块关系

各应用之间通过模型关系实现数据关联。用户是所有数据的拥有者，任务可以属于项目并关联多个标签，形成完整的任务管理系统。

```mermaid
erDiagram
USER {
uuid id PK
string username
string email UK
text bio
timestamp created_at
timestamp updated_at
}
PROJECT {
uuid id PK
string name
string color
boolean is_favorite
int order
uuid user_id FK
timestamp created_at
timestamp updated_at
}
TASK {
uuid id PK
string title
text description
string priority
string status
datetime start_date
datetime due_date
datetime completed_at
int order
boolean is_starred
uuid user_id FK
uuid project_id FK
uuid parent_id FK
timestamp created_at
timestamp updated_at
}
TAG {
uuid id PK
string name UK
string color
uuid user_id FK
timestamp created_at
timestamp updated_at
}
TASK_TAG {
uuid id PK
uuid task_id FK
uuid tag_id FK
timestamp created_at
}
USER ||--o{ PROJECT : "拥有"
USER ||--o{ TASK : "拥有"
USER ||--o{ TAG : "拥有"
PROJECT ||--o{ TASK : "包含"
TASK ||--o{ TASK : "父子"
TASK ||--o{ TASK_TAG : "关联"
TAG ||--o{ TASK_TAG : "关联"
```

**图示来源**
- [users/models.py](file://backend/apps/users/models.py)
- [tasks/models.py](file://backend/apps/tasks/models.py)
- [projects/models.py](file://backend/apps/projects/models.py)
- [tags/models.py](file://backend/apps/tags/models.py)

**本节来源**
- [users/models.py](file://backend/apps/users/models.py)
- [tasks/models.py](file://backend/apps/tasks/models.py)
- [projects/models.py](file://backend/apps/projects/models.py)
- [tags/models.py](file://backend/apps/tags/models.py)

## 配置分析

### 数据库连接
通过`django-environ`库从环境变量读取数据库配置，支持多种数据库类型，提高了配置的灵活性和安全性。

```python
DATABASES = {
    'default': env.db('DATABASE_URL', default='sqlite:///db.sqlite3')
}
```

### JWT认证设置
使用`rest_framework_simplejwt`实现JWT认证，配置了合理的令牌有效期和刷新策略。

```python
SIMPLE_JWT = {
    'ACCESS_TOKEN_LIFETIME': timedelta(days=1),
    'REFRESH_TOKEN_LIFETIME': timedelta(days=7),
    'ROTATE_REFRESH_TOKENS': True,
    'BLACKLIST_AFTER_ROTATION': True,
}
```

### CORS策略
配置了跨域资源共享策略，允许前端应用访问API接口。

```python
CORS_ALLOWED_ORIGINS = env.list(
    'CORS_ALLOWED_ORIGINS',
    default=['http://localhost:5173', 'http://127.0.0.1:5173']
)
CORS_ALLOW_CREDENTIALS = True
```

### 环境变量管理
使用`django-environ`管理环境变量，将敏感信息与代码分离。

```python
env = environ.Env(
    DEBUG=(bool, False)
)
environ.Env.read_env(os.path.join(BASE_DIR, '.env'))
```

**本节来源**
- [settings.py](file://backend/todo_project/settings.py)

## API路由设计

采用RESTful API最佳实践，使用Django REST Framework的路由器自动生成功能完整的CRUD接口。

```mermaid
graph TD
root["/ (根路径)"]
subgraph "管理界面"
admin["/admin/"]
end
subgraph "API文档"
schema["/api/schema/"]
docs["/api/docs/"]
end
subgraph "认证接口"
token["/api/token/"]
refresh["/api/token/refresh/"]
end
subgraph "用户接口"
users["/api/users/"]
users_register["/api/users/register/"]
users_me["/api/users/me/"]
end
subgraph "任务接口"
tasks["/api/tasks/"]
tasks_today["/api/tasks/today/"]
tasks_stats["/api/tasks/statistics/"]
tasks_complete["/api/tasks/{id}/complete/"]
tasks_star["/api/tasks/{id}/toggle_star/"]
end
subgraph "项目接口"
projects["/api/projects/"]
projects_favorite["/api/projects/{id}/toggle_favorite/"]
end
subgraph "标签接口"
tags["/api/tags/"]
task_tags["/api/tags/task-tags/"]
end
root --> admin
root --> schema
root --> docs
root --> token
root --> refresh
root --> users
root --> tasks
root --> projects
root --> tags
```

**图示来源**
- [urls.py](file://backend/todo_project/urls.py)
- [users/urls.py](file://backend/apps/users/urls.py)
- [tasks/urls.py](file://backend/apps/tasks/urls.py)
- [projects/urls.py](file://backend/apps/projects/urls.py)
- [tags/urls.py](file://backend/apps/tags/urls.py)

**本节来源**
- [urls.py](file://backend/todo_project/urls.py)
- [users/urls.py](file://backend/apps/users/urls.py)
- [tasks/urls.py](file://backend/apps/tasks/urls.py)
- [projects/urls.py](file://backend/apps/projects/urls.py)
- [tags/urls.py](file://backend/apps/tags/urls.py)

## MVC架构实现

各应用遵循MVC设计模式，实现了关注点分离。

```mermaid
classDiagram
class UserViewSet {
+queryset User.objects.all()
+serializer_class UserSerializer
+register(request)
+me(request)
}
class TaskViewSet {
+serializer_class TaskSerializer
+get_queryset()
+get_serializer_class()
+complete(task)
+toggle_star(task)
+today()
+statistics()
}
class ProjectViewSet {
+serializer_class ProjectSerializer
+get_queryset()
+toggle_favorite(project)
}
class TagViewSet {
+serializer_class TagSerializer
+get_queryset()
+perform_create(serializer)
+create(request)
}
class UserSerializer {
+Meta.model User
+Meta.fields [...]
+validate(attrs)
+create(validated_data)
}
class TaskSerializer {
+subtasks_count
+tags
+get_subtasks_count(obj)
+get_tags(obj)
+create(validated_data)
+update(instance, validated_data)
}
class ProjectSerializer {
+tasks_count
+get_tasks_count(obj)
+create(validated_data)
}
class TagSerializer {
+Meta.model Tag
+Meta.fields [...]
}
class User {
+username
+email
+avatar
+bio
+created_at
+updated_at
}
class Task {
+title
+description
+priority
+status
+due_date
+is_starred
+created_at
+updated_at
}
class Project {
+name
+color
+is_favorite
+order
+created_at
+updated_at
}
class Tag {
+name
+color
+created_at
+updated_at
}
UserViewSet --> UserSerializer : "使用"
UserViewSet --> User : "操作"
TaskViewSet --> TaskSerializer : "使用"
TaskViewSet --> Task : "操作"
ProjectViewSet --> ProjectSerializer : "使用"
ProjectViewSet --> Project : "操作"
TagViewSet --> TagSerializer : "使用"
TagViewSet --> Tag : "操作"
```

**图示来源**
- [users/views.py](file://backend/apps/users/views.py)
- [tasks/views.py](file://backend/apps/tasks/views.py)
- [projects/views.py](file://backend/apps/projects/views.py)
- [tags/views.py](file://backend/apps/tags/views.py)
- [users/serializers.py](file://backend/apps/users/serializers.py)
- [tasks/serializers.py](file://backend/apps/tasks/serializers.py)
- [projects/serializers.py](file://backend/apps/projects/serializers.py)
- [tags/serializers.py](file://backend/apps/tags/serializers.py)
- [users/models.py](file://backend/apps/users/models.py)
- [tasks/models.py](file://backend/apps/tasks/models.py)
- [projects/models.py](file://backend/apps/projects/models.py)
- [tags/models.py](file://backend/apps/tags/models.py)

**本节来源**
- [users/views.py](file://backend/apps/users/views.py)
- [tasks/views.py](file://backend/apps/tasks/views.py)
- [projects/views.py](file://backend/apps/projects/views.py)
- [tags/views.py](file://backend/apps/tags/views.py)
- [users/serializers.py](file://backend/apps/users/serializers.py)
- [tasks/serializers.py](file://backend/apps/tasks/serializers.py)
- [projects/serializers.py](file://backend/apps/projects/serializers.py)
- [tags/serializers.py](file://backend/apps/tags/serializers.py)

## 组件交互流程

展示请求从URL路由到视图、序列化器再到模型的处理流程。

```mermaid
sequenceDiagram
participant Frontend as 前端应用
participant URL as URL路由
participant View as 视图集
participant Serializer as 序列化器
participant Model as 模型
Frontend->>URL : GET /api/tasks/
URL->>View : 调用TaskViewSet.list()
View->>View : get_queryset() 过滤用户任务
View->>Serializer : 使用TaskSerializer序列化
Serializer->>Model : 访问Task模型字段
Model-->>Serializer : 返回任务数据
Serializer-->>View : 返回序列化数据
View-->>Frontend : 返回JSON响应
Frontend->>URL : POST /api/tasks/
URL->>View : 调用TaskViewSet.create()
View->>Serializer : 使用TaskSerializer验证数据
Serializer->>Serializer : 验证并处理tags字段
Serializer->>Model : 创建Task实例
Model-->>Serializer : 返回创建的任务
Serializer-->>View : 返回序列化数据
View-->>Frontend : 返回201 Created
```

**图示来源**
- [tasks/urls.py](file://backend/apps/tasks/urls.py)
- [tasks/views.py](file://backend/apps/tasks/views.py)
- [tasks/serializers.py](file://backend/apps/tasks/serializers.py)
- [tasks/models.py](file://backend/apps/tasks/models.py)

**本节来源**
- [tasks/urls.py](file://backend/apps/tasks/urls.py)
- [tasks/views.py](file://backend/apps/tasks/views.py)
- [tasks/serializers.py](file://backend/apps/tasks/serializers.py)
- [tasks/models.py](file://backend/apps/tasks/models.py)