# 开发指南

<cite>
**本文档中引用的文件**  
- [README.md](file://README.md)
- [Makefile](file://Makefile)
- [backend/pyproject.toml](file://backend/pyproject.toml)
- [frontend/package.json](file://frontend/package.json)
- [backend/apps/tasks/models.py](file://backend/apps/tasks/models.py)
- [backend/apps/tasks/views.py](file://backend/apps/tasks/views.py)
- [backend/apps/tasks/serializers.py](file://backend/apps/tasks/serializers.py)
- [frontend/src/services/task.ts](file://frontend/src/services/task.ts)
</cite>

## 目录
1. [简介](#简介)
2. [代码规范](#代码规范)
3. [依赖管理](#依赖管理)
4. [代码格式化与质量检查](#代码格式化与质量检查)
5. [Makefile 快捷命令](#makefile-快捷命令)
6. [数据库迁移流程](#数据库迁移流程)
7. [测试编写与运行](#测试编写与运行)
8. [新功能开发工作流](#新功能开发工作流)

## 简介
本开发指南旨在为贡献者提供标准化的开发流程，涵盖代码规范、依赖管理、格式化工具、质量检查、数据库迁移、测试以及新功能开发的完整工作流。项目采用 Django + React 技术栈，前后端分离架构，使用 Docker 进行容器化部署。

## 代码规范

### Python（后端）
后端使用 Python 编写，遵循 PEP 8 代码规范，并通过自动化工具确保代码风格统一。

- **代码格式化**：使用 Black 自动格式化代码
- **导入排序**：使用 isort 对 import 语句进行排序
- **代码检查**：使用 Flake8 检查代码质量与潜在错误

相关配置位于 `backend/pyproject.toml` 中，已包含 black、flake8 和 isort 的 dev-dependencies。

### TypeScript（前端）
前端使用 TypeScript 编写，通过 ESLint 进行静态分析和代码规范检查。

- **代码检查**：使用 ESLint（配合 @typescript-eslint/eslint-plugin）进行类型和语法检查
- **格式化**：可选使用 Prettier 进行代码格式化（当前通过 ESLint 统一处理）

ESLint 配置通过 `package.json` 中的 `lint` 脚本调用，检查所有 `.ts` 和 `.tsx` 文件。

**Section sources**
- [README.md](file://README.md#L243-L269)
- [backend/pyproject.toml](file://backend/pyproject.toml#L18-L25)
- [frontend/package.json](file://frontend/package.json#L45-L55)

## 依赖管理

### Python 依赖管理（uv）
后端使用 `uv` 作为 Python 包管理器，替代传统的 pip。依赖声明在 `backend/pyproject.toml` 文件中。

安装依赖命令：
```bash
cd backend
uv pip install -r pyproject.toml
```

`pyproject.toml` 中定义了生产依赖（如 Django、DRF）和开发依赖（如 pytest、black）。

### 前端依赖管理（pnpm）
前端使用 `pnpm` 作为包管理器，相比 npm/yarn 更节省磁盘空间且安装更快。

安装依赖命令：
```bash
cd frontend
pnpm install
```

依赖项在 `frontend/package.json` 中声明，包括 React、Vite、TailwindCSS 等核心库。

**Section sources**
- [README.md](file://README.md#L99-L103)
- [backend/pyproject.toml](file://backend/pyproject.toml#L6-L16)
- [frontend/package.json](file://frontend/package.json#L12-L43)

## 代码格式化与质量检查

### 后端格式化与检查
使用以下命令进行代码格式化和质量检查：

```bash
# 格式化代码
black .

# 排序导入
isort .

# 检查代码质量
flake8
```

这些工具已在 `pyproject.toml` 中配置，确保团队成员使用一致的代码风格。

### 前端代码检查
前端通过 ESLint 进行代码检查，运行命令如下：

```bash
pnpm lint
```

该命令会检查所有 TypeScript 文件，确保符合项目设定的编码规范，并禁止未使用的禁用指令。

**Section sources**
- [README.md](file://README.md#L251-L269)
- [backend/pyproject.toml](file://backend/pyproject.toml#L18-L25)

## Makefile 快捷命令
项目提供 `Makefile` 以简化常用开发任务，避免重复输入复杂命令。

| 命令 | 说明 |
|------|------|
| `make help` | 显示所有可用命令 |
| `make dev-up` | 启动开发数据库（Docker） |
| `make dev-down` | 停止开发数据库 |
| `make backend-dev` | 启动后端开发服务器 |
| `make frontend-dev` | 启动前端开发服务器 |
| `make prod-up` | 构建并启动生产环境 |
| `make prod-down` | 停止生产环境 |
| `make migrate` | 执行数据库迁移 |
| `make makemigrations` | 创建数据库迁移文件 |
| `make superuser` | 创建 Django 超级用户 |
| `make test` | 运行后端测试 |
| `make clean` | 清理缓存和临时文件 |

这些命令极大提升了开发效率，推荐在日常开发中使用。

**Section sources**
- [Makefile](file://Makefile#L1-L70)

## 数据库迁移流程
Django 使用迁移文件（migrations）来管理数据库模式变更。

### 创建迁移文件
当修改模型（如 `models.py`）后，需生成迁移文件：

```bash
make makemigrations
# 或手动执行
cd backend && python manage.py makemigrations
```

此命令会对比当前模型与数据库状态，生成新的迁移脚本，存放于各应用的 `migrations/` 目录下。

### 应用迁移
将迁移文件应用到数据库，更新表结构：

```bash
make migrate
# 或手动执行
cd backend && python manage.py migrate
```

### 查看迁移状态
查看当前迁移应用情况：

```bash
python manage.py showmigrations
```

示例中 `tasks` 应用已有多个迁移文件（如 `0001_initial.py`、`0003_task_start_date.py`），表明任务模型经历了多次结构演进。

**Section sources**
- [README.md](file://README.md#L274-L281)
- [Makefile](file://Makefile#L52-L57)
- [backend/apps/tasks/models.py](file://backend/apps/tasks/models.py#L1-L74)
- [backend/apps/tasks/migrations/0003_task_start_date.py](file://backend/apps/tasks/migrations/0003_task_start_date.py#L1-L19)

## 测试编写与运行

### 后端测试
后端使用 `pytest` 框架进行测试，支持单元测试和集成测试。

运行测试命令：
```bash
make test
# 或手动执行
cd backend && pytest
```

测试应覆盖核心业务逻辑，如任务创建、状态变更、权限控制等。建议为新增功能编写相应的测试用例。

### 前端测试
前端测试尚未完全配置，但 `package.json` 中已预留 `test` 脚本，未来可集成 Jest 或 Vitest 进行组件和逻辑测试。

**Section sources**
- [README.md](file://README.md#L287-L293)
- [Makefile](file://Makefile#L61-L63)

## 新功能开发工作流
为确保代码质量和协作效率，建议遵循以下开发流程：

1. **创建分支**  
   基于 `main` 分支创建新功能分支：
   ```bash
   git checkout main
   git pull origin main
   git checkout -b feature/new-task-feature
   ```

2. **开发与格式化**  
   编写代码后，使用 Black 和 isort 格式化后端代码，前端运行 `pnpm lint` 确保无错误。

3. **数据库变更**  
   如涉及模型修改，使用 `make makemigrations` 生成迁移文件，并通过 `make migrate` 应用。

4. **编写测试**  
   为新功能编写单元测试，确保功能正确性和回归安全。

5. **本地验证**  
   启动前后端服务（`make backend-dev` 和 `make frontend-dev`），手动测试功能。

6. **提交代码**  
   提交代码并推送至远程仓库，创建 Pull Request 进行代码审查。

7. **合并与清理**  
   经审查通过后合并至 `main` 分支，删除本地和远程功能分支。

此流程确保了代码的可维护性、一致性和稳定性。

**Section sources**
- [README.md](file://README.md#L314-L316)
- [Makefile](file://Makefile#L34-L38)
- [dev-setup.sh](file://dev-setup.sh#L55-L86)